# Type Definitions: Voting Feature

**Feature**: 001-case-voting  
**Date**: 2025-01-30  
**Package**: `@carton/shared`

## Overview

This document defines all TypeScript types, Zod schemas, and type exports for the voting feature. All types follow the constitutional requirement of strict type safety with Prisma as the single source of truth.

---

## Type Flow

```
Prisma Schema (schema.prisma)
    ↓ [prisma generate]
Prisma Client Types (@prisma/client)
    ↓ [zod-prisma-types]
Generated Zod Schemas (packages/shared/src/generated/index.ts)
    ↓ [manual export]
Shared Types (packages/shared/src/types.ts)
    ↓ [import]
Server (tRPC procedures) & Client (React components)
```

---

## Prisma-Generated Types

### Location
`packages/shared/src/generated/index.ts` (auto-generated, do not edit manually)

### VoteType Enum

**Generated from Prisma**:
```prisma
enum VoteType {
  LIKE
  DISLIKE
}
```

**Generated TypeScript Type**:
```typescript
// Auto-generated by Prisma
export type VoteType = 'LIKE' | 'DISLIKE';
```

**Generated Zod Schema**:
```typescript
// Auto-generated by zod-prisma-types
export const VoteTypeSchema = z.enum(['LIKE', 'DISLIKE']);
```

---

### CaseVote Model

**Generated from Prisma**:
```prisma
model CaseVote {
  id        String   @id @default(uuid())
  userId    String
  caseId    String
  voteType  VoteType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@unique([userId, caseId], name: "user_case_vote")
  @@index([caseId])
  @@index([userId])
}
```

**Generated TypeScript Type**:
```typescript
// Auto-generated by Prisma Client
export type CaseVote = {
  id: string;
  userId: string;
  caseId: string;
  voteType: VoteType;
  createdAt: Date;
  updatedAt: Date;
};
```

**Generated Zod Schema**:
```typescript
// Auto-generated by zod-prisma-types
export const CaseVoteSchema = z.object({
  id: z.string().uuid(),
  userId: z.string(),
  caseId: z.string(),
  voteType: VoteTypeSchema,
  createdAt: z.date(),
  updatedAt: z.date(),
});
```

---

## Shared Type Exports

### Location
`packages/shared/src/types.ts`

### Vote Type Exports

```typescript
// Re-export enum schema from generated
export { VoteTypeSchema } from './generated/index.js';
export type { VoteType } from './generated/index.js';

// Lowercase alias for backwards compatibility with existing patterns
export const voteTypeSchema = VoteTypeSchema;

// Helper constants for UI rendering
export const VOTE_TYPE_OPTIONS = [
  { 
    value: 'LIKE' as const, 
    label: 'Like', 
    icon: 'ThumbsUp',
    description: 'Like this case'
  },
  { 
    value: 'DISLIKE' as const, 
    label: 'Dislike', 
    icon: 'ThumbsDown',
    description: 'Dislike this case'
  },
] as const;

// Type for UI options
export type VoteTypeOption = typeof VOTE_TYPE_OPTIONS[number];
```

**Usage in Client**:
```typescript
import { VOTE_TYPE_OPTIONS, VoteType } from '@carton/shared';

VOTE_TYPE_OPTIONS.map(option => (
  <button key={option.value}>
    {option.label} {/* "Like" or "Dislike" */}
  </button>
));
```

---

### Vote Summary Type

**Purpose**: Client-side type for displaying aggregated vote data

```typescript
/**
 * Aggregated vote data for a case
 * Calculated from CaseVote records, not stored in database
 */
export type VoteSummary = {
  /** Total number of LIKE votes */
  likes: number;
  
  /** Total number of DISLIKE votes */
  dislikes: number;
  
  /** Current user's vote type, or null if not voted */
  userVote: VoteType | null;
};
```

**Usage in tRPC Response**:
```typescript
// Server: Calculate and return
const voteSummary: VoteSummary = {
  likes: votes.filter(v => v.voteType === 'LIKE').length,
  dislikes: votes.filter(v => v.voteType === 'DISLIKE').length,
  userVote: votes.find(v => v.userId === ctx.userId)?.voteType || null
};

// Client: Type-safe consumption
const { data } = trpc.case.getById.useQuery({ id: caseId });
const summary: VoteSummary = data.voteSummary;
```

---

### Vote Action Type

**Purpose**: Return type for vote mutation to indicate what action occurred

```typescript
/**
 * Result of a vote mutation
 */
export type VoteAction = 'created' | 'removed' | 'changed';

/**
 * Response from case.vote mutation
 */
export type VoteResponse = {
  /** Action performed on the vote */
  action: VoteAction;
  
  /** The vote record (null if removed) */
  vote: CaseVote | null;
};
```

**Zod Schema for API**:
```typescript
export const voteResponseSchema = z.object({
  action: z.enum(['created', 'removed', 'changed']),
  vote: z.lazy(() => CaseVoteSchema).nullable()
});
```

---

## tRPC Input Schemas

### Location
`packages/server/src/router.ts` (inline in procedure definitions)

### Vote Input Schema

```typescript
const voteInputSchema = z.object({
  /** UUID of the case to vote on */
  caseId: z.string().uuid(),
  
  /** Type of vote (LIKE or DISLIKE) */
  voteType: voteTypeSchema
});

// Type inferred from schema
type VoteInput = z.infer<typeof voteInputSchema>;
// Result: { caseId: string; voteType: VoteType }
```

**Usage in tRPC Procedure**:
```typescript
vote: publicProcedure
  .input(voteInputSchema)
  .mutation(async ({ ctx, input }) => {
    // input is typed as VoteInput
    const { caseId, voteType } = input;
    // ...
  })
```

---

## Client Component Props

### Location
`packages/client/src/components/VoteButtons/VoteButtons.tsx`

### VoteButtons Props

```typescript
/**
 * Props for VoteButtons component
 */
export type VoteButtonsProps = {
  /** ID of the case to vote on */
  caseId: string;
  
  /** Current vote summary data */
  voteSummary: VoteSummary;
  
  /** Whether voting is disabled (e.g., not authenticated) */
  disabled?: boolean;
  
  /** Size variant for buttons */
  size?: 'sm' | 'md' | 'lg';
  
  /** Optional callback when vote changes */
  onVoteChange?: (vote: VoteType | null) => void;
};
```

**Usage**:
```typescript
<VoteButtons
  caseId={caseData.id}
  voteSummary={caseData.voteSummary}
  disabled={!isAuthenticated}
  size="md"
  onVoteChange={(vote) => console.log('Vote changed:', vote)}
/>
```

---

### VoteCount Props (Optional Separate Component)

```typescript
/**
 * Props for VoteCount display component
 */
export type VoteCountProps = {
  /** Number of likes */
  likes: number;
  
  /** Number of dislikes */
  dislikes: number;
  
  /** Display variant */
  variant?: 'inline' | 'stacked' | 'compact';
  
  /** Show icons */
  showIcons?: boolean;
};
```

---

## Type Guards

### Location
`packages/shared/src/helpers.ts` (if needed)

### Vote Type Guards

```typescript
/**
 * Type guard to check if a value is a valid VoteType
 */
export function isVoteType(value: unknown): value is VoteType {
  return value === 'LIKE' || value === 'DISLIKE';
}

/**
 * Type guard to check if a value is a valid VoteSummary
 */
export function isVoteSummary(value: unknown): value is VoteSummary {
  if (typeof value !== 'object' || value === null) return false;
  const v = value as Record<string, unknown>;
  return (
    typeof v.likes === 'number' &&
    typeof v.dislikes === 'number' &&
    (v.userVote === null || isVoteType(v.userVote))
  );
}
```

---

## Extended Types (Case with Votes)

### Server-Side

```typescript
// Prisma query result type
type CaseWithVotes = Prisma.CaseGetPayload<{
  include: {
    votes: {
      select: {
        voteType: true;
        userId: true;
      };
    };
  };
}>;

// Transform to API response type
type CaseWithVoteSummary = Omit<CaseWithVotes, 'votes'> & {
  voteSummary: VoteSummary;
};
```

### Client-Side

```typescript
// Inferred from tRPC router
import type { RouterOutputs } from '@carton/shared/client';

type CaseDetail = RouterOutputs['case']['getById'];
// Includes voteSummary: VoteSummary

type CaseListItem = RouterOutputs['case']['list'][number];
// Includes voteSummary: { likes: number; dislikes: number }
```

---

## Validation Schemas

### Create Vote Validation

```typescript
export const createVoteSchema = z.object({
  caseId: z.string().uuid('Invalid case ID format'),
  voteType: voteTypeSchema
});
```

### Vote Summary Validation

```typescript
export const voteSummarySchema = z.object({
  likes: z.number().int().nonnegative(),
  dislikes: z.number().int().nonnegative(),
  userVote: voteTypeSchema.nullable()
});
```

---

## React Query Types

### Mutation Types

```typescript
import type { UseMutationResult } from '@tanstack/react-query';

type VoteMutation = UseMutationResult<
  VoteResponse,      // TData (response)
  TRPCClientError,   // TError
  VoteInput,         // TVariables (input)
  { previousCase?: CaseDetail } // TContext (for optimistic updates)
>;
```

**Usage**:
```typescript
const voteMutation: VoteMutation = trpc.case.vote.useMutation({
  // ... mutation config
});
```

---

## Type Safety Checklist

- ✅ **No `any` types**: All types explicitly defined
- ✅ **Prisma as source of truth**: CaseVote and VoteType from schema
- ✅ **Auto-generated Zod**: Schemas generated via zod-prisma-types
- ✅ **tRPC inference**: Client types inferred from router
- ✅ **Shared exports**: All types exported from `@carton/shared`
- ✅ **Strict null checks**: `userVote: VoteType | null` (not undefined)
- ✅ **Type guards**: Runtime validation where needed
- ✅ **No type duplication**: Single source for each type

---

## Summary

**Generated Types**: 2 (VoteType, CaseVote)  
**Shared Types**: 3 (VoteSummary, VoteAction, VoteResponse)  
**Component Props**: 2 (VoteButtonsProps, VoteCountProps)  
**Validation Schemas**: 3 (voteInputSchema, voteSummarySchema, voteResponseSchema)  
**Helper Constants**: 1 (VOTE_TYPE_OPTIONS)  
**Type Guards**: 2 (isVoteType, isVoteSummary)

**Type Flow**: Prisma → Generated → Shared → Server & Client  
**Type Safety**: End-to-end via tRPC inference  
**Validation**: Zod schemas at API boundaries  
**Source of Truth**: Prisma schema for all data types
